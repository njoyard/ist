/** @license
 * IST: Indented Selector Templating
 * version 0.5.5
 *
 * Copyright (c) 2012 Nicolas Joyard
 * Released under the MIT license.
 *
 * Author: Nicolas Joyard <joyard.nicolas@gmail.com>
 * http://github.com/k-o-x/ist
 */(function(e){"use strict";var t=typeof e.define=="function"&&e.define.amd,n=function(e){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y=["break","case","catch","class","continue","debugger","default","delete","do","else","enum","export","extends","false","finally","for","function","if","import","in","instanceof","new","null","return","super","switch","this","throw","true","try","typeof","undefined","var","void","while","with"],b=/^[$_a-z][$_a-z0-9]*$/i,w="  ",E={},S=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],x=[];return Array.isArray||(Array.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"}),c=function(e){return b.test(e)&&y.indexOf(e)===-1},r=function(){var e="U",t="I",n="D",r,i,s,o,u,a,f,l;return i=function(r,i){var s=[new d],o=0,u,a,f,l;if(!r)return s[0];a=function(){return s[s.length-1]},f=function(e){o++,s.push(e)},l=function(e){var t;if(s.length<2)throw new Error("Could not pop node from stack");return t=s.pop(),a().appendChild(t),t},u=i.map(function(e){return e.pop()}),u.unshift(r),u.forEach(function(r,i){var s=r.indent,u=r.item,c=r.num,h;if(s[0]instanceof Error)throw s[0];if(o>0)if(s[0]===e)l();else if(s[0]===n){l();while(s.length>0)s.pop(),l()}else if(s[0]===t&&a()instanceof m)throw h=new Error("Cannot add children to text node"),h.line=c,h;f(u)});while(s.length>1)l();return a()},s=function(r,i,s){var o=i.length,u=[],a;o.length===0&&r.push(o);if(o==r[0])return[e];if(o>r[0])return r.unshift(o),[t];while(o<r[0])r.shift(),u.push(n);return o!=r[0]?(a=new Error("Unexpected indent"),a.line=s,a.column=1,[a]):u},u=function(e,t){return new m(e,t)},a=function(e,t,n,r){var i=new g(e,r);return t.forEach(function(e){typeof e.id!="undefined"?i.setId(e.id):typeof e.className!="undefined"?i.setClass(e.className):typeof e.attr!="undefined"?i.setAttribute(e.attr,e.value):typeof e.prop!="undefined"?i.setProperty(e.prop,e.value):typeof e.event!="undefined"&&i.setEventHandler(e.event,e.value)}),typeof n!="undefined"&&(n.partial.length>0&&i.setPartialName(n.partial),n.textnode instanceof m&&i.appendChild(n.textnode)),i},f=function(e,t,n){return new v(e,t,n)},o=function(e){return e.length>1?String.fromCharCode(parseInt(e,16)):{f:"\f",b:"\b",t:"	",n:"\n",r:"\r"}[e]||e},l=function(){function e(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var t={parse:function(t,n){function d(e,t,n){var r=e,i=n-e.length;for(var s=0;s<i;s++)r=t+r;return r}function v(e){var t=e.charCodeAt(0),n,r;return t<=255?(n="x",r=2):(n="u",r=4),"\\"+n+d(t.toString(16).toUpperCase(),"0",r)}function m(e){var t={};for(var n in e)t[n]=e[n];return t}function g(e,n){var r=e.offset+n;for(var i=e.offset;i<r;i++){var s=t.charAt(i);s==="\n"?(e.seenCR||e.line++,e.column=1,e.seenCR=!1):s==="\r"||s==="\u2028"||s==="\u2029"?(e.line++,e.column=1,e.seenCR=!0):(e.column++,e.seenCR=!1)}e.offset+=n}function y(e){if(l.offset<h.offset)return;l.offset>h.offset&&(h=m(l),p=[]),p.push(e)}function b(){var e,t,n,r,s,o,u,a;o=m(l),u=m(l),e=[],t=x();while(t!==null)e.push(t),t=x();if(e!==null){t=E(),t=t!==null?t:"";if(t!==null){n=[],a=m(l),s=x();if(s!==null){r=[];while(s!==null)r.push(s),s=x()}else r=null;r!==null?(s=E(),s!==null?r=[r,s]:(r=null,l=m(a))):(r=null,l=m(a));while(r!==null){n.push(r),a=m(l),s=x();if(s!==null){r=[];while(s!==null)r.push(s),s=x()}else r=null;r!==null?(s=E(),s!==null?r=[r,s]:(r=null,l=m(a))):(r=null,l=m(a))}if(n!==null){r=[],s=x();while(s!==null)r.push(s),s=x();r!==null?e=[e,t,n,r]:(e=null,l=m(u))}else e=null,l=m(u)}else e=null,l=m(u)}else e=null,l=m(u);return e!==null&&(e=function(e,t,n,r,s){return i(r,s)}(o.offset,o.line,o.column,e[1],e[2])),e===null&&(l=m(o)),e}function w(){var e;return c++,/^[ \t]/.test(t.charAt(l.offset))?(e=t.charAt(l.offset),g(l,1)):(e=null,c===0&&y("[ \\t]")),c--,c===0&&e===null&&y("whitespace"),e}function E(){var e,t,n,r,i,s;i=m(l),s=m(l),e=S();if(e!==null){t=P(),t===null&&(t=F(),t===null&&(t=X()));if(t!==null){n=[],r=w();while(r!==null)n.push(r),r=w();n!==null?e=[e,t,n]:(e=null,l=m(s))}else e=null,l=m(s)}else e=null,l=m(s);return e!==null&&(e=function(e,t,n,r,i){return{indent:r,item:i,num:t}}(i.offset,i.line,i.column,e[0],e[1])),e===null&&(l=m(i)),e}function S(){var e,t,n;c++,n=m(l),e=[],t=w();while(t!==null)e.push(t),t=w();return e!==null&&(e=function(e,t,n,r){return s(K,r,t)}(n.offset,n.line,n.column,e)),e===null&&(l=m(n)),c--,c===0&&e===null&&y("indent"),e}function x(){var e;return c++,t.charCodeAt(l.offset)===10?(e="\n",g(l,1)):(e=null,c===0&&y('"\\n"')),c--,c===0&&e===null&&y("new line"),e}function T(){var e;return c++,/^[^\n]/.test(t.charAt(l.offset))?(e=t.charAt(l.offset),g(l,1)):(e=null,c===0&&y("[^\\n]")),c--,c===0&&e===null&&y("character"),e}function N(){var e,n,r,i,s;c++,i=m(l),s=m(l),/^[a-z_]/i.test(t.charAt(l.offset))?(e=t.charAt(l.offset),g(l,1)):(e=null,c===0&&y("[a-z_]i"));if(e!==null){n=[],/^[a-z0-9_\-]/i.test(t.charAt(l.offset))?(r=t.charAt(l.offset),g(l,1)):(r=null,c===0&&y("[a-z0-9_\\-]i"));while(r!==null)n.push(r),/^[a-z0-9_\-]/i.test(t.charAt(l.offset))?(r=t.charAt(l.offset),g(l,1)):(r=null,c===0&&y("[a-z0-9_\\-]i"));n!==null?e=[e,n]:(e=null,l=m(s))}else e=null,l=m(s);return e!==null&&(e=function(e,t,n,r,i){return r+i.join("")}(i.offset,i.line,i.column,e[0],e[1])),e===null&&(l=m(i)),c--,c===0&&e===null&&y("identifier"),e}function C(){var e,n,r,i;return r=m(l),i=m(l),t.charCodeAt(l.offset)===33?(e="!",g(l,1)):(e=null,c===0&&y('"!"')),e!==null?(n=N(),n!==null?e=[e,n]:(e=null,l=m(i))):(e=null,l=m(i)),e!==null&&(e=function(e,t,n,r){return r}(r.offset,r.line,r.column,e[1])),e===null&&(l=m(r)),e}function k(){var e,n,r,i;return r=m(l),i=m(l),t.charCodeAt(l.offset)===35?(e="#",g(l,1)):(e=null,c===0&&y('"#"')),e!==null?(n=N(),n!==null?e=[e,n]:(e=null,l=m(i))):(e=null,l=m(i)),e!==null&&(e=function(e,t,n,r){return{id:r}}(r.offset,r.line,r.column,e[1])),e===null&&(l=m(r)),e}function L(){var e,n,r,i;return r=m(l),i=m(l),t.charCodeAt(l.offset)===46?(e=".",g(l,1)):(e=null,c===0&&y('"."')),e!==null?(n=N(),n!==null?e=[e,n]:(e=null,l=m(i))):(e=null,l=m(i)),e!==null&&(e=function(e,t,n,r){return{className:r}}(r.offset,r.line,r.column,e[1])),e===null&&(l=m(r)),e}function A(){var e,n,r;r=m(l),e=[],n=R(),n===null&&(/^[^\\\n\]]/.test(t.charAt(l.offset))?(n=t.charAt(l.offset),g(l,1)):(n=null,c===0&&y("[^\\\\\\n\\]]")));while(n!==null)e.push(n),n=R(),n===null&&(/^[^\\\n\]]/.test(t.charAt(l.offset))?(n=t.charAt(l.offset),g(l,1)):(n=null,c===0&&y("[^\\\\\\n\\]]")));return e!==null&&(e=function(e,t,n,r){return r.join("")}(r.offset,r.line,r.column,e)),e===null&&(l=m(r)),e}function O(){var e,n,r,i,s,o,u;return o=m(l),u=m(l),t.charCodeAt(l.offset)===91?(e="[",g(l,1)):(e=null,c===0&&y('"["')),e!==null?(n=N(),n!==null?(t.charCodeAt(l.offset)===61?(r="=",g(l,1)):(r=null,c===0&&y('"="')),r!==null?(i=A(),i!==null?(t.charCodeAt(l.offset)===93?(s="]",g(l,1)):(s=null,c===0&&y('"]"')),s!==null?e=[e,n,r,i,s]:(e=null,l=m(u))):(e=null,l=m(u))):(e=null,l=m(u))):(e=null,l=m(u))):(e=null,l=m(u)),e!==null&&(e=function(e,t,n,r,i){return{attr:r,value:i}}(o.offset,o.line,o.column,e[1],e[3])),e===null&&(l=m(o)),e}function M(){var e,n,r,i,s,o,u,a;return u=m(l),a=m(l),t.charCodeAt(l.offset)===91?(e="[",g(l,1)):(e=null,c===0&&y('"["')),e!==null?(t.charCodeAt(l.offset)===46?(n=".",g(l,1)):(n=null,c===0&&y('"."')),n!==null?(r=N(),r!==null?(t.charCodeAt(l.offset)===61?(i="=",g(l,1)):(i=null,c===0&&y('"="')),i!==null?(s=A(),s!==null?(t.charCodeAt(l.offset)===93?(o="]",g(l,1)):(o=null,c===0&&y('"]"')),o!==null?e=[e,n,r,i,s,o]:(e=null,l=m(a))):(e=null,l=m(a))):(e=null,l=m(a))):(e=null,l=m(a))):(e=null,l=m(a))):(e=null,l=m(a)),e!==null&&(e=function(e,t,n,r,i){return{prop:r,value:i}}(u.offset,u.line,u.column,e[2],e[4])),e===null&&(l=m(u)),e}function _(){var e,n,r,i,s,o,u,a;return u=m(l),a=m(l),t.charCodeAt(l.offset)===91?(e="[",g(l,1)):(e=null,c===0&&y('"["')),e!==null?(t.charCodeAt(l.offset)===33?(n="!",g(l,1)):(n=null,c===0&&y('"!"')),n!==null?(r=N(),r!==null?(t.charCodeAt(l.offset)===61?(i="=",g(l,1)):(i=null,c===0&&y('"="')),i!==null?(s=A(),s!==null?(t.charCodeAt(l.offset)===93?(o="]",g(l,1)):(o=null,c===0&&y('"]"')),o!==null?e=[e,n,r,i,s,o]:(e=null,l=m(a))):(e=null,l=m(a))):(e=null,l=m(a))):(e=null,l=m(a))):(e=null,l=m(a))):(e=null,l=m(a)),e!==null&&(e=function(e,t,n,r,i){return{event:r,value:i}}(u.offset,u.line,u.column,e[2],e[4])),e===null&&(l=m(u)),e}function D(){var e;return c++,e=k(),e===null&&(e=L(),e===null&&(e=O(),e===null&&(e=M(),e===null&&(e=_())))),c--,c===0&&e===null&&y("element qualifier"),e}function P(){var e;return c++,e=H(),e===null&&(e=B()),c--,c===0&&e===null&&y("element"),e}function H(){var e,t,n,r;n=m(l),r=m(l),t=D();if(t!==null){e=[];while(t!==null)e.push(t),t=D()}else e=null;return e!==null?(t=j(),t!==null?e=[e,t]:(e=null,l=m(r))):(e=null,l=m(r)),e!==null&&(e=function(e,t,n,r,i){return a("div",r,i,t)}(n.offset,n.line,n.column,e[0],e[1])),e===null&&(l=m(n)),e}function B(){var e,t,n,r,i;r=m(l),i=m(l),e=N();if(e!==null){t=[],n=D();while(n!==null)t.push(n),n=D();t!==null?(n=j(),n!==null?e=[e,t,n]:(e=null,l=m(i))):(e=null,l=m(i))}else e=null,l=m(i);return e!==null&&(e=function(e,t,n,r,i,s){return a(r,i,s,t)}(r.offset,r.line,r.column,e[0],e[1],e[2])),e===null&&(l=m(r)),e}function j(){var e,t,n,r,i,s,o;r=m(l),i=m(l),s=m(l),o=m(l),t=w();if(t!==null){e=[];while(t!==null)e.push(t),t=w()}else e=null;e!==null?(t=F(),t!==null?e=[e,t]:(e=null,l=m(o))):(e=null,l=m(o)),e!==null&&(e=function(e,t,n,r){return r}(s.offset,s.line,s.column,e[1])),e===null&&(l=m(s)),e=e!==null?e:"";if(e!==null){s=m(l),o=m(l),n=w();if(n!==null){t=[];while(n!==null)t.push(n),n=w()}else t=null;t!==null?(n=C(),n!==null?t=[t,n]:(t=null,l=m(o))):(t=null,l=m(o)),t!==null&&(t=function(e,t,n,r){return r}(s.offset,s.line,s.column,t[1])),t===null&&(l=m(s)),t=t!==null?t:"",t!==null?e=[e,t]:(e=null,l=m(i))}else e=null,l=m(i);return e!==null&&(e=function(e,t,n,r,i){return{textnode:r,partial:i}}(r.offset,r.line,r.column,e[0],e[1])),e===null&&(l=m(r)),e}function F(){var e,t;return c++,t=m(l),e=W(),e!==null&&(e=function(e,t,n,r){return u(r,t)}(t.offset,t.line,t.column,e)),e===null&&(l=m(t)),c--,c===0&&e===null&&y("text node"),e}function I(){var e,n,r,i,s,o,u;return o=m(l),u=m(l),t.charCodeAt(l.offset)===117?(e="u",g(l,1)):(e=null,c===0&&y('"u"')),e!==null?(/^[0-9a-z]/i.test(t.charAt(l.offset))?(n=t.charAt(l.offset),g(l,1)):(n=null,c===0&&y("[0-9a-z]i")),n!==null?(/^[0-9a-z]/i.test(t.charAt(l.offset))?(r=t.charAt(l.offset),g(l,1)):(r=null,c===0&&y("[0-9a-z]i")),r!==null?(/^[0-9a-z]/i.test(t.charAt(l.offset))?(i=t.charAt(l.offset),g(l,1)):(i=null,c===0&&y("[0-9a-z]i")),i!==null?(/^[0-9a-z]/i.test(t.charAt(l.offset))?(s=t.charAt(l.offset),g(l,1)):(s=null,c===0&&y("[0-9a-z]i")),s!==null?e=[e,n,r,i,s]:(e=null,l=m(u))):(e=null,l=m(u))):(e=null,l=m(u))):(e=null,l=m(u))):(e=null,l=m(u)),e!==null&&(e=function(e,t,n,r,i,s,o){return""+r+i+s+o}(o.offset,o.line,o.column,e[1],e[2],e[3],e[4])),e===null&&(l=m(o)),e}function q(){var e,n,r,i,s;return i=m(l),s=m(l),t.charCodeAt(l.offset)===120?(e="x",g(l,1)):(e=null,c===0&&y('"x"')),e!==null?(/^[0-9a-z]/i.test(t.charAt(l.offset))?(n=t.charAt(l.offset),g(l,1)):(n=null,c===0&&y("[0-9a-z]i")),n!==null?(/^[0-9a-z]/i.test(t.charAt(l.offset))?(r=t.charAt(l.offset),g(l,1)):(r=null,c===0&&y("[0-9a-z]i")),r!==null?e=[e,n,r]:(e=null,l=m(s))):(e=null,l=m(s))):(e=null,l=m(s)),e!==null&&(e=function(e,t,n,r,i){return""+r+i}(i.offset,i.line,i.column,e[1],e[2])),e===null&&(l=m(i)),e}function R(){var e,n,r,i;return r=m(l),i=m(l),t.charCodeAt(l.offset)===92?(e="\\",g(l,1)):(e=null,c===0&&y('"\\\\"')),e!==null?(n=I(),n===null&&(n=q(),n===null&&(n=T())),n!==null?e=[e,n]:(e=null,l=m(i))):(e=null,l=m(i)),e!==null&&(e=function(e,t,n,r){return o(r)}(r.offset,r.line,r.column,e[1])),e===null&&(l=m(r)),e}function U(){var e,n,r,i,s;i=m(l),s=m(l),t.charCodeAt(l.offset)===34?(e='"',g(l,1)):(e=null,c===0&&y('"\\""'));if(e!==null){n=[],r=R(),r===null&&(/^[^\\\n"]/.test(t.charAt(l.offset))?(r=t.charAt(l.offset),g(l,1)):(r=null,c===0&&y('[^\\\\\\n"]')));while(r!==null)n.push(r),r=R(),r===null&&(/^[^\\\n"]/.test(t.charAt(l.offset))?(r=t.charAt(l.offset),g(l,1)):(r=null,c===0&&y('[^\\\\\\n"]')));n!==null?(t.charCodeAt(l.offset)===34?(r='"',g(l,1)):(r=null,c===0&&y('"\\""')),r!==null?e=[e,n,r]:(e=null,l=m(s))):(e=null,l=m(s))}else e=null,l=m(s);return e!==null&&(e=function(e,t,n,r){return r.join("")}(i.offset,i.line,i.column,e[1])),e===null&&(l=m(i)),e}function z(){var e,n,r,i,s;i=m(l),s=m(l),t.charCodeAt(l.offset)===39?(e="'",g(l,1)):(e=null,c===0&&y('"\'"'));if(e!==null){n=[],r=R(),r===null&&(/^[^\\\n']/.test(t.charAt(l.offset))?(r=t.charAt(l.offset),g(l,1)):(r=null,c===0&&y("[^\\\\\\n']")));while(r!==null)n.push(r),r=R(),r===null&&(/^[^\\\n']/.test(t.charAt(l.offset))?(r=t.charAt(l.offset),g(l,1)):(r=null,c===0&&y("[^\\\\\\n']")));n!==null?(t.charCodeAt(l.offset)===39?(r="'",g(l,1)):(r=null,c===0&&y('"\'"')),r!==null?e=[e,n,r]:(e=null,l=m(s))):(e=null,l=m(s))}else e=null,l=m(s);return e!==null&&(e=function(e,t,n,r){return r.join("")}(i.offset,i.line,i.column,e[1])),e===null&&(l=m(i)),e}function W(){var e;return c++,e=U(),e===null&&(e=z()),c--,c===0&&e===null&&y("quoted text"),e}function X(){var e;return c++,e=$(),e===null&&(e=V()),c--,c===0&&e===null&&y("directive"),e}function V(){var e,n,r,i;return r=m(l),i=m(l),t.charCodeAt(l.offset)===64?(e="@",g(l,1)):(e=null,c===0&&y('"@"')),e!==null?(n=N(),n!==null?e=[e,n]:(e=null,l=m(i))):(e=null,l=m(i)),e!==null&&(e=function(e,t,n,r){return f(r,undefined,t)}(r.offset,r.line,r.column,e[1])),e===null&&(l=m(r)),e}function $(){var e,n,r,i,s,o,u;o=m(l),u=m(l),t.charCodeAt(l.offset)===64?(e="@",g(l,1)):(e=null,c===0&&y('"@"'));if(e!==null){n=N();if(n!==null){i=w();if(i!==null){r=[];while(i!==null)r.push(i),i=w()}else r=null;if(r!==null){s=T();if(s!==null){i=[];while(s!==null)i.push(s),s=T()}else i=null;i!==null?e=[e,n,r,i]:(e=null,l=m(u))}else e=null,l=m(u)}else e=null,l=m(u)}else e=null,l=m(u);return e!==null&&(e=function(e,t,n,r,i){return f(r,i.join(""),t)}(o.offset,o.line,o.column,e[1],e[3])),e===null&&(l=m(o)),e}function J(e){e.sort();var t=null,n=[];for(var r=0;r<e.length;r++)e[r]!==t&&(n.push(e[r]),t=e[r]);return n}var r={templateLines:b,__:w,line:E,indent:S,newline:x,character:T,identifier:N,partial:C,elemId:k,elemClass:L,squareBracketsValue:A,elemAttribute:O,elemProperty:M,elemEventHandler:_,elemQualifier:D,element:P,implicitElement:H,explicitElement:B,elementAdditions:j,textNode:F,escapedUnicode:I,escapedASCII:q,escapedCharacter:R,doubleQuotedText:U,singleQuotedText:z,quotedText:W,directive:X,simpleDirective:V,exprDirective:$};if(n!==undefined){if(r[n]===undefined)throw new Error("Invalid rule name: "+e(n)+".")}else n="templateLines";var l={offset:0,line:1,column:1,seenCR:!1},c=0,h={offset:0,line:1,column:1,seenCR:!1},p=[],K=[0],Q=r[n]();if(Q===null||l.offset!==t.length){var G=Math.max(l.offset,h.offset),Y=G<t.length?t.charAt(G):null,Z=l.offset>h.offset?l:h;throw new this.SyntaxError(J(p),Y,G,Z.line,Z.column)}return Q},toSource:function(){return this._source}};return t.SyntaxError=function(t,n,r,i,s){function o(t,n){var r,i;switch(t.length){case 0:r="end of input";break;case 1:r=t[0];break;default:r=t.slice(0,t.length-1).join(", ")+" or "+t[t.length-1]}return i=n?e(n):"end of input","Expected "+r+" but "+i+" found."}this.name="SyntaxError",this.expected=t,this.found=n,this.message=o(t,n),this.offset=r,this.line=i,this.column=s},t.SyntaxError.prototype=Error.prototype,t}(),l}(),o=function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\t]/g,"\\t").replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r")},l=function(e){var t,n;try{n=document.querySelectorAll("script#"+e)}catch(r){return}return n&&Array.prototype.slice.call(n).forEach(function(e){!t&&e.getAttribute("type")==="text/x-ist"&&(t=e.innerHTML)}),t},s=function(e,t,n){t.prototype=new e,Object.keys(n).forEach(function(e){t.prototype[e]=n[e]})},h=function(e,t){this.value=e,this.doc=t||document,this.variables={document:[this.doc]},this.contextNames=typeof e=="object"&&e!==null?Object.keys(e).filter(c):[],this.contextValues=this.contextNames.map(function(t){return e[t]})},h.prototype={createDocumentFragment:function(){return this.doc.createDocumentFragment()},createElement:function(e,t){return typeof t!="undefined"?this.doc.createElementNS(t,e):this.doc.createElement(e)},createTextNode:function(e){return this.doc.createTextNode(this.interpolate(e))},pushEvalVar:function(e,t){typeof this.variables[e]=="undefined"&&(this.variables[e]=[]),this.variables[e].unshift(t)},popEvalVar:function(e){var t=this.variables[e].shift();return this.variables[e].length===0&&delete this.variables[e],t},evaluate:function(e){var t=this,n=Object.keys(this.variables),r,i;return r=n.map(function(e){return t.variables[e][0]}),i=new Function(this.contextNames.concat(n).join(","),"return "+e+";"),i.apply(this.value,this.contextValues.concat(r))},interpolate:function(e){return e.replace(/{{((?:}(?!})|[^}])*)}}/g,function(e,t){return this.evaluate(t)}.bind(this))},createContext:function(e){return new h(e,this.doc)}},p=function(e){this.partialName=e||""},p.prototype={sourceLine:"<unknown>",sourceFile:"<unknown>",completeError:function(e){var t="in '"+(this.sourceFile||"<unknown>")+"'";return typeof this.sourceLine!="undefined"&&(t+=" on line "+this.sourceLine),typeof e.istStack=="undefined"&&(e.message+=" "+t,e.istStack=[]),e.istStack.push(t),e},setPartialName:function(e){this.partialName=e},findPartial:function(e){if(this.partialName===e)return this},render:function(e,t){return e instanceof h||(e=new h(e,t)),this._render(e)},_render:function(e){throw new Error("Cannot render base Node")},_getCode:function(){throw new Error("Cannot get base Node code")}},m=function(e,t,r){p.call(this,r),this.text=e,this.sourceFile=n.currentTemplate,this.sourceLine=t},s(p,m,{_render:function(e){try{return e.createTextNode(this.text)}catch(t){throw this.completeError(t)}},_getCode:function(e){return e+"new ist.TextNode("+JSON.stringify(this.text)+", "+JSON.stringify(this.sourceLine)+", "+JSON.stringify(this.partialName)+")"},appendChild:function(e){throw new Error("Cannot add children to TextNode")}}),d=function(e,t){p.call(this,e),this.children=t||[],this.partialCache={}},s(p,d,{appendChild:function(e){this.children.push(e)},findPartial:function(e){var t=p.prototype.findPartial.call(this,e),n,r;return t?t:typeof this.partialCache[e]!="undefined"?this.partialCache[e]:(t=this.children.reduce(function(t,n){return t||n.findPartial(e)},null),t&&(this.partialCache[e]=t),t)},_render:function(e){var t=e.createDocumentFragment();return this.children.forEach(function(n){t.appendChild(n._render(e))}),t},_getChildrenCode:function(e){return this.children.length===0?"[]":"[\n"+this.children.map(function(t){return t._getCode(e)}).join(",\n")+"\n"+e+"]"},_getCode:function(e){return e+"new ist.ContainerNode("+JSON.stringify(this.partialName)+", "+this._getChildrenCode(e+w)+")"}}),g=function(e,t,r,i,s,o,u,a,f){d.call(this,r,i),this.tagName=e,this.sourceFile=n.currentTemplate,this.sourceLine=t,this.attributes=s||{},this.properties=o||{},this.eventHandlers=u||{},this.classes=a||[],this.id=f},s(d,g,{setEventHandler:function(e,t){typeof this.eventHandlers[e]=="undefined"?this.eventHandlers[e]=[t]:this.eventHandlers[e].push(t)},setAttribute:function(e,t){this.attributes[e]=t},setProperty:function(e,t){this.properties[e]=t},setClass:function(e){this.classes.push(e)},setId:function(e){this.id=e},_render:function(e){var t=this,n=e.createElement(this.tagName);return n.appendChild(d.prototype._render.call(this,e)),Object.keys(this.attributes).forEach(function(r){try{var i=e.interpolate(t.attributes[r])}catch(s){throw t.completeError(s)}n.setAttribute(r,i)}),Object.keys(this.properties).forEach(function(r){try{var i=e.interpolate(t.properties[r])}catch(s){throw t.completeError(s)}n[r]=i}),Object.keys(this.eventHandlers).forEach(function(r){t.eventHandlers[r].forEach(function(i){try{var s=e.evaluate(i)}catch(o){throw t.completeError(o)}n.addEventListener(r,s,!1)})}),this.classes.forEach(function(e){n.classList.add(e)}),typeof this.id!="undefined"&&(n.id=this.id),n},_getCode:function(e){return e+"new ist.ElementNode("+JSON.stringify(this.tagName)+", "+JSON.stringify(this.sourceLine)+", "+JSON.stringify(this.partialName)+", "+this._getChildrenCode(e+w)+", "+JSON.stringify(this.attributes)+", "+JSON.stringify(this.properties)+", "+JSON.stringify(this.eventHandlers)+", "+JSON.stringify(this.classes)+", "+JSON.stringify(this.id)+")"}}),v=function(e,t,r,i,s){d.call(this,i,s),this.name=e,this.expr=t,this.sourceFile=n.currentTemplate,this.sourceLine=r},s(d,v,{_render:function(e){var t=this,n={},r,i;if(typeof E[this.name]!="function")throw new Error("No block helper for @"+this.name+" has been registered");if(typeof this.expr!="undefined")try{r=e.createContext(e.evaluate(this.expr))}catch(s){throw this.completeError(s)}n.render=d.prototype.render.bind(n),n._render=d.prototype._render.bind(t);try{i=E[this.name].call(e,r,n)}catch(s){throw this.completeError(s)}return typeof i=="undefined"?e.createDocumentFragment():i},_getCode:function(e){return e+"new ist.BlockNode("+JSON.stringify(this.name)+", "+JSON.stringify(this.expr)+", "+JSON.stringify(this.sourceLine)+", "+JSON.stringify(this.partialName)+", "+this._getChildrenCode(e+w)+")"}}),u=function(e){var t=/\r\n|\r|\n/,n=/^[ \t]*$/,r=/\/\*((?:\/(?!<\*)|[^\/])*?)\*\//g,i;return e=e.replace(r,function(e,n){return n.split(t).map(function(e){return""}).join("\n")}),i=e.split(t),i.forEach(function(e,t){e.match(n)&&(i[t]="")}),e=i.join("\n"),e},n=function(e,t){var i;n.currentTemplate=t||"<unknown>";try{i=r.parse(u(e))}catch(s){throw s.message+=" in '"+n.currentTemplate+"' on line "+s.line+(typeof s.column!="undefined"?", character "+s.column:""),n.currentTemplate=undefined,s}return n.currentTemplate=undefined,i},n.TextNode=m,n.ContainerNode=d,n.ElementNode=g,n.BlockNode=v,n.createNode=function(e,t,r){var i=e.split(">").map(function(e){return e.trim()}),s="",o="",u;return i.forEach(function(e){o+="\n"+s+e,s+=" "}),u=n(o).render(t,r),u.childNodes.length===1?u.firstChild:u},n.fromScriptTag=function(e){var t=l(e);if(t)return n(t)},n.registerHelper=function(e,t){E[e]=t},n.registerHelper("if",function(e,t){if(e.value)return t.render(this)}),n.registerHelper("unless",function(e,t){if(!e.value)return t.render(this)}),n.registerHelper("with",function(e,t){return t.render(e)}),n.registerHelper("each",function(e,t){var n=this.createDocumentFragment(),r=this.value,i=e.value;return i&&Array.isArray(i)&&i.forEach(function(s,o){var u=e.createContext(s);u.pushEvalVar("loop",{first:o==0,index:o,last:o==i.length-1,length:i.length,outer:r}),n.appendChild(t.render(u)),u.popEvalVar("loop")}),n}),n.registerHelper("eachkey",function(e,t){var n=this.createDocumentFragment(),r=this.value,i=e.value,s;return i&&(s=Object.keys(i),s.forEach(function(o,u){var a=e.createContext({key:o,value:i[o],loop:{first:u==0,index:u,last:u==s.length-1,length:s.length,object:i,outer:r}});n.appendChild(t.render(a))})),n}),n.registerHelper("include",function(r,i){var s=r.value.replace(/\.ist$/,""),o,u,a;u=l(s);if(t){a=[s,s+".ist","ist!"+s,"text!"+s+".ist"];while(!u&&a.length)try{u=e(a.shift())}catch(f){}}if(!u)throw new Error("Cannot find included template '"+s+"'");typeof u=="string"&&(u=n(u,s));if(typeof u.render=="function")return u.render(this,i.document);throw new Error("Invalid included template '"+s+"'")}),t&&(typeof window!="undefined"&&window.navigator&&window.document?(a=function(){var e,t,n;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;for(t=0;t<3;t++){n=S[t];try{e=new ActiveXObject(n)}catch(r){}if(e){S=[n];break}}if(!e)throw new Error("getXhr(): XMLHttpRequest not available");return e},f=function(e,t){var n=a();n.open("GET",e,!0),n.onreadystatechange=function(r){if(n.readyState===4){if(n.status!==200)throw new Error("HTTP status "+n.status+" when loading "+e);t(n.responseText)}},n.send(null)}):typeof process!="undefined"&&process.versions&&!!process.versions.node&&(i=require.nodeRequire("fs"),f=function(e,t){var n=i.readFileSync(e,"utf8");n.indexOf("﻿")===0&&(n=n.substring(1)),t(n)}),n.write=function(e,t,n){var r="ist!"+t;if(x.hasOwnProperty(r)){var i=x[r];n(i)}},n.load=function(e,t,r,i){var s,u,a=!0;/!bare$/.test(e)&&(a=!1,e=e.replace(/!bare$/,"")),s=t.toUrl(e+".ist"),u=e.indexOf("/")===-1?".":e.replace(/\/[^\/]*$/,""),f(s,function(f){var c,h,p,d=["ist"];f=f.replace(/^(\s*)@include\s+(?:text=)?(['"])((?:(?=(\\?))\4.)*?)\2/gm,function(e,t,n,r){if(!l(r)){var i=u+"/"+r.replace(/\.ist$/,"");return d.indexOf("ist!"+i)===-1&&d.push("ist!"+i),t+'@include "'+i+'"'}return e}),a?(c=n(f)._getCode("  "),f="define('ist!"+e+"',"+JSON.stringify(d)+", function(ist) {\n"+"  ist.currentTemplate = '"+e+"';\n"+"  return "+c+";\n"+"});\n"):i.isBuild?(f=o(f),f="define('ist!"+e+"',"+JSON.stringify(d)+",function(ist){"+"var template='"+f+"';"+"return ist(template,'"+e+"');"+"});"):(f=o(f).replace(/\\n/g,"\\n' +\n	               '"),f="define('ist!"+e+"',"+JSON.stringify(d)+", function(ist){ \n"+"	var template = '"+f+"';\n"+"	return ist(template, '"+e+"');\n"+"});\n"),i.isBuild&&(x["ist!"+e]=f),i.isBuild||(f+="\r\n//@ sourceURL="+s),r.fromText("ist!"+e,f),t(["ist!"+e],function(e){r(e)})})}),n};if(t)define("ist",["require"],n);else{var r=e.ist;e.ist=n(),e.ist.noConflict=function(){var t=e.ist;return e.ist=r,t}}})(this);