<!DOCTYPE html>
<html>
<head>
    <title>IST test runner</title>
</head>
<body>
    <script src="lib/requirejs/require.js"></script>
    
    <script type="text/x-ist" id="timingTemplate">
    	dl
    		dt "Number of runs"
    		dd "{{ runs }}"
    		
	    	@each tests
		    	dt[style=font-weight: bold;] "{{ name }}"
		    	dd
		    		ul
			    		li "Total time: {{ time }} ms"
			    		li "Time per run: {{ time / loop.outer.runs }} ms"
			    		li "Previous times per run: {{ prev.map(function(t){ return t/loop.outer.runs + ' ms'; }).join(', ') }}"
			    		li "Runs per second: {{ 1000 * loop.outer.runs / time }}"
    </script>
    
    <script>
        require({
            baseUrl: 'spec',
            paths: {
            	'text': '../lib/requirejs/text',
            	'ist': '../../dist/ist'
            },
            waitSeconds: 3600
        });

        require(
            ['ist', 'timings'],
            function(ist, timings){
	        	var runs = 200,
	        		tests = [];
		        		
            	window.run = function() {
            		tests = [];
		        
		        	Object.keys(timings).forEach(function(name) {
		        		var test, i, time, start, end;

		        		var prev = localStorage.getItem("ist test " + name);
		        		if (prev) { prev = JSON.parse(prev); }
		        		else { prev = []; }
		        		
		        		console.log("Running " + name + "...");
		        		test = timings[name];

		        		if (test.before) {
		        			test.before();
		        		}

		        		start = Date.now();
		        		for (i = 0; i < runs; i++) {
		        			test();
		        		}
		        		end = Date.now();
		        		
		        		tests.push({
		        			name: name,
		        			time: end - start,
		        			prev: prev.slice(0)
		        		});

		        		prev.unshift(end - start);
		        		while (prev.length > 10) prev.pop();

		        		localStorage.setItem("ist test " + name, JSON.stringify(prev));
		        	});
		        	
		        	console.log("All done.");
		        };
		        
		        window.report = function() {
		        	document.body.appendChild(ist.script("timingTemplate").render({ tests: tests, runs: runs }));
		        };
		        
		        run(); report();
            }
        );
    </script>
</body>
</html>
